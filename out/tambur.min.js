(function(d,b){var g=1,i={};d.static_url="tamburio.github.com/tambur.js/";d.api_host="api.tambur.io";d.balancer_host="balancer.tambur.io";d.WebSocket=false;function f(l){var m=g+=1,k=(l.ssl===true?"https://":"http://")+d.balancer_host+"/"+l.api_key+"/"+l.app_id+"?instance="+m+"&callback=tambur.jsonp_connect_ws",j=document.createElement("script");i[m]=l;j.setAttribute("type","text/javascript");j.setAttribute("src",k);if(typeof j!=="undefined"){document.getElementsByTagName("head")[0].appendChild(j)}}function e(j){window.WEB_SOCKET_SWF_LOCATION=(j.ssl===true?"https://":"http://")+d.static_url+"WebSocketMainInsecure.swf";d.utils.fetch_js("min/tambur_flash.min.js",function(){d.logger.debug("trigger_flash_socket_init returned, start with normal socket init");d.WebSocket=window.WebSocket;f(j)})}function c(k,p){k.retry=0;if(k.nr_of_msgs===0){k.subscriber_id=p.data.substr(3);k.ready()}else{p=JSON.parse(p.data);if(p[0]==="ack"){var n=p[1];if(n>0){var j=p[2];var l=k.response_handler[n];l(j);delete k.response_handler[n]}else{throw"process error: "+p[2]}}else{if(p[0]==="msg"){var o=p[1];var m=p.splice(2);if(k.streams[o]){k.streams[o].dispatch(m)}}}}k.nr_of_msgs+=1}function h(k){k.subscriber_id=false;k.socket=false;k.nr_of_msgs=0;var j=k.retry;if(k.retry<k.max_retries){setTimeout(function(){k=new d.Connection(k);k.retry=j},1000);j+=1}}function a(){return{api_key:false,app_id:false,ready:function(){},ssl:false,max_retries:10,subscriber_id:false,streams:{},socket:false,retry:0,nr_of_msgs:0,response_handler:{},calls:[],nr_of_calls:0,get_stream:function(j){if(typeof this.streams[j]==="undefined"){this.streams[j]=new d.Stream(this,j)}return this.streams[j]}}}d.Connection=function(){var j=a();if(arguments.length===1&&typeof arguments[0]==="object"){var l=arguments[0];j.api_key=l.api_key;j.app_id=l.app_id;j.ready=l.ready||function(){};j.ssl=l.ssl||false;j.max_retries=l.max_retries||10}else{j.api_key=arguments[0];j.app_id=arguments[1]}var k=function(){if(!window.TAMBUR_FORCE_FLASH&&(window.WebSocket!==b||window.MozWebSocket!==b)){d.WebSocket=window.WebSocket||window.MozWebSocket;f(j)}else{e(j)}};if(window.JSON!==b){k()}else{d.utils.fetch_js("min/json2.min.js",k)}return j};d.jsonp_connect_ws=function(l,k){d.logger.debug("jsonp_connect_ws returned: "+k);var j=i[l];j.socket=new d.WebSocket((j.ssl===true?"wss://":"ws://")+k);j.socket.onopen=function(){d.logger.debug("socket["+l+"] onopen")};j.socket.onmessage=function(m){d.logger.debug("socket["+l+"] onmessage: "+m.data);c(j,m)};j.socket.onclose=function(){d.logger.debug("socket["+l+"] onclose");h(j)}};if(window.JSON==b){}}(window.tambur=window.tambur||{}));(function(a,b){if(window.TAMBUR_DEBUG){if(window.TAMBUR_LOGGER){a.logger=TAMBUR_LOGGER}else{if(window.console&&window.console.log&&window.console.error){a.logger=window.console}else{a.logger={log:function(){},error:function(){},debug:function(){}}}}}else{a.logger={log:function(){},error:function(){},debug:function(){}}}}(window.tambur=window.tambur||{}));(function(a,b){a.utils={fetch_js:function(d,e){var c=document.createElement("script");d=("https:"===document.location.protocol?"https://":"http://")+a.static_url+d;c.setAttribute("type","text/javascript");c.setAttribute("src",d);c.onreadystatechange=e;c.onload=e;if(typeof c!=="undefined"){document.getElementsByTagName("head")[0].appendChild(c)}}}}(window.tambur=window.tambur||{}));(function(a,g){function b(j){if(!j.active){var i=j.connection.nr_of_calls+=1,h=["subscribe",i,j.name];j.connection.response_handler[i]=function(k){if(k==="ok"){j.active=true}};a.logger.debug(h);j.connection.socket.send(JSON.stringify(h))}}function d(j){if(j.active){var i=j.connection.nr_of_calls+=1,h=["unsubscribe",i,j.name];j.connection.response_handler[i]=function(k){if(k==="ok"){j.active=false}};a.logger.debug(h);j.connection.socket.send(JSON.stringify(h))}}function f(m,l,h,k){if(m.active&&!m.enabled_modes[l]){var j=m.connection.nr_of_calls+=1,i=["set_mode",j,l,m.name];m.connection.response_handler[j]=function(n){if(n==="ok"){m.enabled_modes[l]=true;m.onenabled(l)}};if(typeof k!=="undefined"){i.push(k)}i.push(h);a.logger.debug(i);m.connection.socket.send(JSON.stringify(i))}}function e(l,k,j){if(l.active&&l.enabled_modes[k]){var i=l.connection.nr_of_calls+=1,h=["unset_mode",i,k,l.name];if(k==="direct"){h.push(j)}l.connection.response_handler[i]=function(m){if(m==="ok"){l.enabled_modes[k]=false;l.ondisabled(k)}};a.logger.debug(h);l.connection.socket.send(JSON.stringify(h))}}function c(l,j,k){if(l.active&&l.enabled_modes.direct){var i=l.connection.nr_of_calls=+1,h=["direct",i,l.name,j,k];l.connection.response_handler[i]=function(m){if(m==="ok"){a.logger.debug("message dispatched to: "+j)}else{a.logger.debug("not able to dispatch message: "+k+"for reason: "+m)}};a.logger.debug(h);l.connection.socket.send(JSON.stringify(h))}}a.Stream=function(h,i){var j={name:i,active:false,is_private:false,connection:h,ready:function(){},onmessage:function(){},onauth:function(){},onpresence:function(){},ondirect:function(){},onenabled:function(){},ondisabled:function(){},enabled_modes:{auth:false,presence:false,direct:false},direct_user_id:false,close:function(){d(this)},reopen:function(){b(this)},enable_auth:function(k){f(this,"auth",k)},enable_presence:function(k,l){f(this,"presence",l,k)},enable_direct:function(k,l){this.direct_user_id=k;f(this,"direct",l,k)},disable_auth:function(){e(this,"auth","")},disable_presence:function(){e(this,"presence","")},disable_direct:function(){e(this,"direct",this.direct_user_id)},direct_msg:function(k,l){c(this,k,l)},dispatch:function(m){var l=m[0];var k=m[1];a.logger.debug("stream["+this.name+"] dispatch msg:"+m);if(l==="auth"){this.onauth(k)}else{if(l==="presence"){this.onpresence(k)}else{if(l==="direct"){this.ondirect(k)}else{this.onmessage(k)}}}}};if(i==="private"){j.is_private=true;j.active=true;delete j.ready;delete j.onauth;delete j.onpresence;delete j.ondirect;delete j.onenabled;delete j.ondisabled;delete j.enabled_modes;delete j.direct_user_id;delete j.close;delete j.reopen;delete j.enable_auth;delete j.enable_presence;delete j.enable_direct;delete j.disable_auth;delete j.disable_presence;delete j.disable_direct;delete j.direct_msg}else{b(j)}return j}}(window.tambur=window.tambur||{}));